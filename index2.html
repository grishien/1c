Создал(а) Дьяченко Александр Павлович, редактировал(а) Ванина Екатерина Александровна 10 февр., 2025

Введение
Общая информация об обменах
Основные понятия и структура нашего обмена РИБ
Центральная База (далее ЦБ) и региональные базы.
МРУ - межрегиональный узел
Виды обмена
Основные проблемы, которые необходимо решить при организации обмена
Использование системы регистрации объектов на обмен
Регистрация изменений через состав плана обмена.
Регистрация документов через регистр сведений "Регистрация документов".
Работа подписки "ПриЗаписиДокумента"
Работа подписки "ОчисткаПолучателей"
Регистрация изменений по дате.
Регистрация изменений по реквизиту.
Регистрация изменений конфигурации
Переданные не переданные данные
Сериализация данных для передачи
Передача данных
Механизм передачи больших таблиц с генерацией SQL запросов
SQL XML регистры сведений
Передача конфигурации для обновления региональных баз
Выбор канала связи
Организация постоянного обмена информацией между базами
Регистрация объектов для обмена.
Контроль за порядком выгрузки - загрузки
Выгрузка данных
Отправка в подчиненный.
Отправка в родительский.
Ограничение выгружаемых данных
ПЕРВЫЙ СПОСОБ при выгрузке
Проверка документов на выгрузку в узел
Проверка регистров на выгрузку в узел
Правила которые необходимо соблюдать при составлении ограничений в функции ПолучитьПравилоПроверкиПриВыгрузкеЗапрос()
ВТОРОЙ СПОСОБ при получении данных от Главного/Подчиненного
Индивидуальные проверки по типу объект метаданных в процедуре ПриПолученииДанныхОтПодчиненного
Индивидуальные проверки по типу метаданных в процедуре ПриПолученииДанныхОтГлавного.
Индивидуальные проверки по типу метаданных в процедуре ПриОтправкеДанныхПодчиненному.
ТРЕТИЙ СПОСОБ при чтении сообщения обмена
Загрузка данных
Оптимизация загрузки данных
Инструменты для контроля обменов
Мониторинг
Мониторинг в базе 1С
План обмена
Статистика по времени загрузки
Журнал регистрации
Уведомления
Телеграмм
Rocket.Chat
Технологический журнал
Те, у кого единая база – мечтают ее разделить.
Те, у кого разделенные базы – мечтают их объединить
Дмитрий Баранов


Введение
Данный материал предназначен для того, чтобы сформировать представление об основных проблемах, с которыми приходится сталкиваться при организации передачи данных между несколькими системами. Тут будут описаны подходы, которые используются в наших конфигурациях для решения этих проблем на примере базового обмена.
Материал будет полезен любому ИТ специалисту, так как в нем есть разъяснения о работе наших систем с точки зрения миграции данных между базами. А эти знания важны как при добавлении новых объектов в базе (необходимо правильно выбирать схему миграции объектов), так и при конвертации объектов, когда необходимо знать, как именно работает обмен, чтобы не допустить его деградации.

Общая информация об обменах
Немного информации об обменах от фирмы 1С:

http://v8.1c.ru/overview/Term_000000269.htm

Механизмы обмена данными позволяют создавать территориально распределенные информационные системы обменивающиеся данными в офф-лайн режиме без постоянного соединения. С помощью этих механизмов можно осуществлять интеграцию не только между различными информационными базами 1С:Предприятия, но и строить сложные информационные системы, включающие, наряду с решениями на платформе 1С:Предприятие, еще и внешние приложения.
Существует множество причин, по которым необходимо организовать обмен между разными информационными системами.
Причины для разделения баз могут быть самыми разными. Перечислим лишь некоторые из них:

Географическая (подразделения фирмы расположены далеко от сервера, где находится база. В результате этого работать невозможно из-за долгого отклика системы).
Для экономической безопасности (необходимо дать доступ к данным каким-либо внешним пользователям (аудиторы, партнеры), которым нежелательно иметь доступ ко всем данным предприятия).
Технические (количество одновременно подключенных пользователей превышает предел, при котором им комфортно работать).
Требуется ведение баз в разрезе отдельных юридических лиц, которые используют различные принципы налогообложения, деятельности и прочее.
Также возможны обмены с внешними системами (например, сайт и др.), для которых важны только определенные объекты. Данные системы перегружают всю необходимую им информацию и впоследствии обмениваются с 1С результатами своей работы.
Можно выделить 2 вида обмена по разности архитектур баз:

Механизм распределенных информационных баз (РИБ). Этот механизм предназначен для обмена данными только с идентичными конфигурациями 1С:Предприятия 8 и жестко регламентирует структуру создаваемой системы.
http://v8.1c.ru/overview/Term_000000315.htm
Универсальный механизм обмена данными. Этот механизм позволяет создавать произвольные распределенные системы и практически не накладывает никаких ограничений на структуру создаваемой системы.
http://v8.1c.ru/overview/Term_000000314.htm
У нас используются оба вида обменов. Но в нашем материале мы будем рассматривать только РИБ.

Основные понятия и структура нашего обмена РИБ
Прежде чем разговаривать о том, как устроен обмен РИБ в ДНС, хотелось бы напомнить и описать все понятия, которые мы в дальнейшем будем использовать.

Центральная База (далее ЦБ) и региональные базы.
Конфигурации у них идентичны, однако набор данных немного различается. Вследствие чего мы имеем сложную структуру разделения баз данных.
В настоящее время (05.03.2019) размер центральной базы составляет около 12,5 ТБ. Это накладывает определенные сложности и ограничения на администрирование, создание бэкапов и разворачивание базы. Региональные базы в разы меньше по объему, поэтому их разворачивать гораздо быстрее. Также они являются резервным источником данных, если в ЦБ данные были испорчены (но это ровно до того, как пройдет обмен).
Однако наличие большого числа баз накладывает ограничения на их поддержку и обновления. Так как при обновлении накладывается блокировка на работу пользователей, то при большом количестве баз время обновления может быть растянуто и выходить за рамки технологического окна (время, когда производится обновление баз), что может приводить к жалобам пользователей. Также большое количество баз означает большое количество обменов, что имеет свои отрицательные стороны:

Нагрузка на ЦБ, так как в итоге в ней аккумулируются все данные из других баз.
Проблема конфликтных данных, когда одни и те же данные могут меняться практически одновременно в разных системах.
Проблема потерянных данных, когда данные могут "потеряться" при переходе из одной базы в другую (редко, но случается).

Посмотреть структуру разделения данных можно вот тут:

http://adm-monitor-dev:52081/

Схематично выглядит вот так:

Головной узел - центральная база(УБД) - информационная система, в которую сливаются все необходимые данные из дочерних узлов. С нее же и расходится измененная конфигурация на дочерние узлы.
Дочерний узел - полная структурная копия головного узла, но со своим необходимым набором данных. У нас дочерние узлы разделены по регионам.

МРУ - межрегиональный узел
В данном случае это некоторая дополнительная база, созданная для переноса одного (нескольких) филиала в другую административно-территориальную единицу компании (дивизион). Как вариант, копируется некоторая база (например, ЦБ), в нее настраиваются обмены с нужной территориально-административной единицы (например ДВ) и нужного филиала, и все данные переливаются в эту БД дополнительно к остальным базам. После чего будут удалены избыточные данные и заменена целевая БД (в нашем примере — база ДВ).

Виды обмена
РИБ – позволяет обмениваться конфигурациями.
Универсальный – позволяет обмениваться только данными.
Дополнительно к вышеперечисленному хотелось бы отметить тот факт, что иногда в обмене, как и в любой другой системе, могут возникать ошибки. Связано это может быть с различными причинами как со стороны человеческого фактора, так и с техническим сбоем. В этом случае разбираться с ошибкой будет ответственный сотрудник.
В ДНС мы используем одновременно стандартный РИБ 1С и универсальный план обмена 1С:

1. Распределенная конфигурация – обмен только конфигурацией. Состав не заполнен. На обмен будет отправляться только конфигурация






2. Базовый – обмен только данными между базами.





В нашем случае мы делаем следующим образом:

Формируем пакет данных из РИБ, получаем XML файл.
Далее этот файл мы дополняем из базового обмена именно данными.
Загрузка такого XML происходит в едином методе, но в зависимости от тегов в файле загружаются данные от соответствующего плана обмена.
При таком подходе к организации обмена мы усложняем его структуру, однако получаем возможность влиять на организацию выгрузки данных, ограничивать количество данных в выгрузке, использовать дополнительные инструменты контроля выгрузки, например: "РС.СтатистикаПоВремениЗагрузки_" (регистр необходим для сбора статистики по времени загрузки/выгрузки данных ИБД), "РС.РегистрацияДокументов" (альтернативная регистрация документов для обмена данными. Будет заполняться ПриЗаписи каждого документа с помощью подписки на событие "ПриЗаписиДокумента").

Основные проблемы, которые необходимо решить при организации обмена
Когда нам необходимо организовать обмен между разными информационными системами, мы должны ответить на ряд вопросов.

Каким образом мы будем понимать, какие данные необходимо передать в другую базу?
Нам нужна некая система, которая позволит отслеживать изменения данных в текущей базе и составлять очередь из объектов, которые необходимо переслать в другую базу.

У нас есть очередь объектов на обмен. А какие объекты мы уже отправили, а какие объекты нам только предстоит отправить?
Нам нужны признаки того, что данные еще не отправлены. Данные отправлены, и мы ждем, пока их примет другая сторона. И также нужно понимать, что вся необходимая информация уже принята другой стороной.

Каким образом мы будем сериализовывать данные для передачи из текущей базы в другую базу данных?
Нужен какой-то простой способ преобразовать данные из БД в виде строки для дальнейшей передачи.

Каким образом будет осуществляться передача данных между системами?
У нас есть несколько баз данных, которые могут быть размещены где угодно: на разных серверах, в разных подсетях и так далее. Нам необходим надежный способ передачи данных между двумя этими базами.

Каким образом организовать постоянную автоматическую синхронизация данных между базами?
Данные между нашими системами должны синхронизироваться постоянно. Для каких-то систем раз в сутки, для других — раз в 10 минут. Как это организовать?

Теперь можно перейти к более детальному описанию каждой проблемы и описанию того, как именно в нашей компании она решена.
Для начала рассмотрим процессы, которые происходят непосредственно в каждой ИБД. Потом мы перейдем к описанию коммуникаций между системами.

Использование системы регистрации объектов на обмен
В каждой из баз мы будем формировать очередь объектов на обмен, которые в дальнейшем будем пересылать. Будем называть этот процесс - регистрацией объектов на обмен. В дальнейшем объекты из этой очереди будут выгружаться в очередной пакет обмена. Мы будем рассматривать обмен по распределенной информационной базе с помощью файлов. Все эти процессы будут описаны позднее.
Для того чтобы понимать, какие именно данные необходимо передать в другую базу, есть несколько способов регистрации изменений.

Регистрация изменений через состав плана обмена.
Немного информации о стандартной системе регистрации объектов на обмен от фирмы 1С:

http://v8.1c.ru/overview/Term_000000151.htm

Объект добавляется в состав плана обмена, после этого срабатывают стандартные механизмы 1С, и начинает заполняться таблица изменений объекта. Как работает таблица изменений, можно прочитать в статье.

Планы обмена 1С

Особенности регистраций через план в конфигурации ДНС:

Если записывается документ, то срабатывает подписка ПриЗаписиДокумента, и информация о получателях удаляется из таблицы изменений, но срабатывает другой механизм, про который будет ниже в пункте "Регистрация документов через регистр сведений "Регистрация документов"".
Если объект включен в подписку нзТолькоВверх, которая срабатывает перед записью объекта, то в зависимости от типа узла (головной, дочерний) сработает разный алгоритм:
Если узел головной - в таблице изменений будет очищена информация о получателях из базового плана обмена.
Если узел дочерний - в таблице изменений будет очищена информация о получателях (это не коснется узлов исключений, но мы не рассматриваем их в контексте РИБ). Будет добавлена регистрация только в головной узел.
Если у объекта ОбменДанными.Загрузка стоит в ИСТИНЕ, то никакие алгоритмы из подписки не будут применены, а значит регистрация пройдет на все узлы.

Регистрация документов через регистр сведений "Регистрация документов".
Один из минусов регистрации через план обмена это то, что информация о изменениях находится в разных таблицах (для каждого объекта своя) и соответственно выгружать данные мы тоже будем порознь. В результате может получиться так, что документ будет отправлен/записан, а движения нет и наоборот. Для того чтобы этого избежать, была разработана регистрация через РС.РегистрацияДокументов.
При записи документа срабатывает подписка ПриЗаписиДокумента. Суть ее такова:

Если по документу нет никаких движений, то дальше срабатывает стандартный механизм регистрации изменений 1С. 
Также, чтобы отработал стандартный механизм, необходимо в дополнительные свойства объекта вставить свойство РегестрироватьВ_РС в значении ЛОЖЬ.
Почитать про это можно в этой статье:
Оптимизация конвертации при помощи "ОбменДанными.Загрузка = Истина" и "ДополнительныеСвойства.Вставить("РегестрироватьВ_РС", Ложь)"
Если документ содержит движения, то он будет записан в регистр "РегистрацияДокументов". И при этом регистрация документа и всех его движений при помощи стандартного механизма будет снята. 
Структура регистра

Узел - ссылка на узел плана обмена.
Ссылка - ссылка на документ.
НомерСообщения - число - в отличие от стандартной таблицы изменений, при регистрации изменений имеет значение 0, а не NULL.
НомерВыборкиВПакете - на текущий момент не используется. 
ВыгружатьТолькоДокумент - булево - на текущий момент не используется. 

Работа подписки "ПриЗаписиДокумента"
Если объект "Документ" зарегистрирован на узел одного из типов, которые можно получить в функции ОбменДаннымиСервер.ТипыУзловДляРС_РегистрацияДокументов(), то информация об этом документе будет удалена из таблицы изменений данного объекта и добавлена в РС.РегистрацияДокументов, также будут удалены и получатели у объекта.
Объект ПараметрыСеанса.МассивПолучателейДокумента будет заполнен ссылкой на документ и массивом узлов для удаления. Этот объект будет использован в подписке ОчисткаПолучателей.

Работа подписки "ОчисткаПолучателей"
В этой подписке участвуют регистры сведений с подчинением по регистратору, регистры накоплений и регистры бухгалтерии.
Подписка срабатывает перед записью и получает список узлов, которые необходимо удалить из получателей. Либо из ПараметрыСеанса.МассивПолучателейДокумента, либо из РС.РегистрацияДокументов. Все полученные узлы удаляются из получателей.

Обе подписки работают в паре, и результатом является регистрация документа и всех его движений в одном месте — в РС.РегистрацияДокументов. Это позволяет выгрузить документ и движения одним блоком и так же загрузить его, записав данные в транзакции. Тем самым мы избегаем коллизий в данных, когда есть документ, но нет движений и наоборот.

Регистрация изменений по дате.
У нас в базе существуют достаточно большие таблицы, которые заполняются при помощи SQL-запросов. Зарегистрировать изменения для данной таблицы будет очень дорого, ко всему прочему, нет смысла такую таблицу писать при помощи 1С в подчиненную базу, так как это зайдем достаточно много времени. Поэтому была разработана система регистрации по времени, которая позволяет отправить в обмен записи, созданные, начиная с определенного момента времени.
Для того чтобы воспользоваться этой системой необходимо:

В объект внести поле с типом дата и время, в котором будет фиксироваться дата его изменения.
В перечислении ВидыДанныхДляРегистрацииПоВремени создать элемент, характеризующий наш объект.
В регистре РегистрацияПоВремени по данному элементу перечисления фиксировать информацию по последней выгруженной записи. Смещать дату желательно после получения даты последней выгруженной записи в ответном пакете. Иначе есть риск потери данных.
Пример - РегистрСведений.Цены_НоменклатурыТекущие.

ВАЖНО!!! Тут мы рассказали только о том, как регистрируются изменения. Но отдельно нужны будут функции для выгрузки данных в пакет обмена и для загрузки.

Регистрация изменений по реквизиту.
В объекте создается реквизит с типом булево.
После выгрузки реквизит меняет значение.
Например, реквизит "Выгружать" после выгрузки меняет значение с Истина на Ложь.

В качестве примера можно рассмотреть регистр сведений "ПоказателиБизнесПроцессов". Логика обмена описана в модуле менеджера. 

ВАЖНО!!! Этот метод не стоит использовать, так как он требует полностью перезаписать объект в базу после выгрузки! А это лишняя нагрузка на базу. 

Регистрация изменений конфигурации
Регистрация изменений происходит стандартными средствами 1С: в плане обмена РаспределеннаяКонфигурация установлена галочка Распределенная информационная база. Необходимость выгрузки изменений конфигурации определяется перед началом выгрузки данных при помощи SQL запроса к таблице _ConfigChngR (похожа на таблицы изменений других объектов) с отбором по узлу, в который выгружаем. Если изменения есть, то проверяем константу Digest2, изменялась ли она после обновления текущей базы. Если нет, то генерируем новую:


Константы.Digest2.Установить(СтрЗаменить(Строка(Новый УникальныйИдентификатор), "-", ""));
Данная константа служит неким уникальным идентификатором текущей конфигурации, при помощи которого можно сравнить версии конфигураций разных баз. Создаем файл обмена и записываем в него изменения конфигурации, используя стандартный метод ПланыОбмена.ЗаписатьИзменения(). Изменения помещаются в блок Changes. Здесь же создаются стандартные элементы Digest1 и Digest2, которые содержат цифровые подписи передаваемых в данном сообщении изменений конфигурации и всей конфигурации за вычетом изменений (не связаны с одноименной константой, но именно на их основе она была сделана). После этого создается блок ChangesData, куда далее будут записаны изменения данных.

Переданные не переданные данные
В каждой из баз присутствует описание тех узлов, с которыми база производит обмен.
К примеру в ЦБ есть информация о том, что база обменивается со всеми региональными базами. А в региональной базе есть только узел центральной базы, с которым фактически и происходит обмен данными.
Когда работает система регистрации изменений объектов на обмен, мы помечаем конкретные объекты как зарегистрированные на обмен в конкретный узел. Таким образом для каждого узла, участвующего в обмене с данной информационной базой, существует свой список объектов, которые необходимо переслать при помощи обменов.

В компании ДНС обмен выполнен по схеме - “полудуплексный обмен с квитанцией подтверждения”. "Полудуплексный" означает, что мы не можем одновременно выгружать и загружать данные, только по очереди. Квитанция подтверждения  - это информация о том, что отправленный ранее пакет принят принимающей стороной. В ответном пакете мы получаем данные о том, какой выгруженный нами пакет был успешно загружен принимающей стороной. Таким образом, в нашем случае квитанция подтверждения — это номер последнего принятого пакета.

Для реализации подобной схемы все пакеты содержат два номера: номер этого пакета и номер последнего загруженного пакета. Эти номера являются стандартными реквизитами плана обмена.
1С самостоятельно управляет нумерацией:
При выгрузке:

увеличиваем номер отправленного (хранится в узле) на 1 и записываем в файл;
номер принятого (хранится в узле) записываем в файл.
При загрузке:

по номеру принятого (из файла) очищаем регистрацию;
номер отправленного (из файла) записываем в номер принятого (хранится в узле).
Таким образом, номер принятого пакета, отправленный обратно, является квитанцией подтверждения доставки пакета. Как правило, мы не влияем на нумерацию пакетов, но в случае сбоя в ней, у нас есть код при выгрузке, который восстанавливает последовательность.


Если кПодчиненному Тогда
	Если (Получатель.НомерОтправленного > Получатель.НомерПринятого) и (не НеПроверятьПоследовательность) Тогда Возврат Результат; КонецЕсли;
	Если Результат.УзелОбъект.НомерПринятого > Результат.УзелОбъект.НомерОтправленного Тогда
		Результат.УзелОбъект.НомерОтправленного = Результат.УзелОбъект.НомерПринятого;
		Результат.УзелОбъект.Записать();
	КонецЕсли;
Иначе
	Если (Получатель.НомерОтправленного >= Получатель.НомерПринятого) и (не НеПроверятьПоследовательность) Тогда Возврат Результат; КонецЕсли;
	Если Результат.УзелОбъект.НомерПринятого - Результат.УзелОбъект.НомерОтправленного > 1 Тогда
		Результат.УзелОбъект.НомерОтправленного = Результат.УзелОбъект.НомерПринятого - 1;
		Результат.УзелОбъект.Записать();
	КонецЕсли;
КонецЕсли;
Схематически процесс проставления номеров выглядит вот так:





Сериализация данных для передачи
У нас есть очередь объектов на обмен. Надо придумать какой-то способ сериализовать эти данные и в дальнейшем передать их по каналу связи в другую информационную систему. Также нам надо каким-либо образом передавать информацию об обновлении баз данных. 

Передача данных
Для передачи данных мы будем использовать все доступные методы встроенные в 1С. Это

XML - сериализация http://v8.1c.ru/overview/Term_000000318.htm
JSON - сериализация http://v8.1c.ru/o7/201501json/index.htm
Передача данных при помощи прямых SQL запросов.
SQL XML для  регистры сведений
Опишем подробно последние два пункта, так как они имеют ряд особенностей.

Механизм передачи больших таблиц с генерацией SQL запросов
Некоторые данные обмена выгружаются и загружаются с использованием прямой записи данных в SQL таблицы БД. На текущий момент таким образом обрабатываются данные следующих объектов:

РС.ТекущийОстатокТовара (переведен на новую схему читай ниже)
РС.ПодневныйПрогнозПродаж
РС.СегментыЕмкостей_РейтингПозицийПоФилиалам
В формируемые SQL команды попадают все записи этих регистров, еще не отмеченные как ранее выгруженные. На выгрузку отбираются все записи, у которых «ВремяЗаписи» (реквизит в регистре) лежит между последним зафиксированным моментом выгрузки и текущей датой (за исключением записей последней минуты на момент формирования сообщения обмена).

Момент фиксации последней выгрузки берется из РС «РегистрацияПоВремени» в разрезе узла обмена и обрабатываемого объекта. Отметка времени, по которую происходит выборка данных из регистра, также записывается в XML сообщение. При успешной загрузке данных это значение записывается в РС «РегистрацияПоВремени» как новая отсечка времени, с которой нужно отбирать еще не отправленные записи на обмен при формировании данных следующей выгрузки.

При формировании выгрузки для обмена в XML данных выгрузки формируется специальное сообщение, в которое записываются данные для обмена в виде SQL команд, а также информация о наименование метода, который должен будет прочитать и обработать эти данные при загрузке (имя метода указывается в атрибуте сообщения "ProcedureRead").
Данные для обмена записываются в виде набора XML элементов "Blok", каждый из которых содержит текст SQL запроса, представляющий из себя построчную выборку данных для обмена через использование SELECT по принципу:



                SELECT <данные первой записи для выгрузки>

                UNION ALL

                SELECT <данные второй записи для выгрузки>

                UNION ALL

                SELECT <данные следующей записи для выгрузки>

                И так далее

В каждый блок попадает не более 1000 записей. Количество блоков определяется объемом выгружаемых данных. Данные для записи – это конкретные значения данных выгружаемых объектов, полученные запросом к регистру.

Деление на блоки необходимо из-за того что вставка SQL текста ограничена и не позволяет вставлять "простыни" текста. Эту проблему решает передача данных через параметры. (см. Таблица значений в параметрах SQL запроса)

При чтении такого блока принимающей стороной происходит вызов метода, наименование которого было записано в атрибут "ProcedureRead". Например, в случае РС.ТекущийОстатокТовара происходит вызов процедуры "ЗагрузитьОстаткиТоваров".

В методе загрузки для каждого набора данных, переданного в элементе «Blok» в виде запроса SELECT, формируется прямой запрос к БД, обновляющий данные соответствующего объекта обмена непосредственно в SQL таблице базы данных. Запрос формируется как SQL команда MERGE, объединяющая текущие данные в таблице данных объекта и данные переданной в сообщении обмена команды SELECT.

См. T-SQL MERGE: https://docs.microsoft.com/ru-ru/sql/t-sql/statements/merge-transact-sql?view=sql-server-2017.

В результате выполнения MERGE в таблице данных объекта будут обновлены уже существующие записи и добавлены ранее в ней отсутствующие данные, переданные в SELECT. 

РС.ТекущийОстатокТовара - переведен на новую схему с передачей строк регистра через параметры. (см. Оптимизация выгрузки текущих остатков)

SQL XML регистры сведений
Подробно тут: Миграция регистров сведений через SQL XML

Передача конфигурации для обновления региональных баз
Так как мы используем РИБ - то при пересылке пакета нам также надо отправлять и текущую конфигурацию базы данных, чтобы подчиненные базы смогли произвести обновление. Для этого мы воспользуемся методом из механизма РИБ, который подготавливает для обмена конфигурацию базы в виде строки.

Все процессы описанные ранее происходят в каждой базе, участвующей в обмене. У нас есть понимание того, какой информацией должны обменяться базы и теперь мы можем приступить к описанию того, как происходит передача данных.

Выбор канала связи
Передачу сообщения можно организовать различными способами:

Использовать расшаренную папку, через которую будет производить обмен файлами.
Использовать FTP-сервер для передачи файлов.
Использовать брокера сообщений (Apache Kafka или RabbitMQ) для передачи сообщений в удобном для нас формате. Почитать можно вот тут Apache Kafka. 
Данная технология интересна с точки зрения производительности и на текущий момент идет ее изучение для дальнейшего использования у нас в обменах. 
Использовать WEB-сервисы или HTTP-сервисы для пересылки сообщений. В качеств примера можно привести обмен 1С ЦБ с SDMS. (устарела) Обмен данными с 1С:УБД Центральная
Использовать различные варианты прямых подключений к базе данных, начиная от COM соединений непосредственно к базе 1С и заканчивая соединением непосредственно с базой данных SQL.
Здесь перечислены наиболее часто встречающиеся способы организации передачи данных. В нашей компании мы используем расшаренные папки для обменов данными между базами по расписанию. Это самый простой и самый понятный способ передачи данных. И для его использования необходимо просто расшарить соответствующие ресурсы, через которые будет производиться обмен сообщения.

Организация постоянного обмена информацией между базами
В базе постоянно происходят процессы, связанные с регистрацией объектов на обмен, и периодически (по расписанию) запускаются процессы, отвечающие за передачу данных между системами.
Обмен можно разделить на четыре процесса:

Регистрация объектов для обмена.
Контроль за порядком выгрузки/загрузки.
Выгрузка объектов в файл.
Загрузка объектов из файла.
Если графически представить 35 минут работы базы, то это будет примерно выглядеть так:

Более подробно на каждом из процессов остановимся ниже.

Регистрация объектов для обмена.
В базе постоянно в результате работы пользователей происходят изменение данных.
У нас постоянно работает система регистрации объектов для обмена, и таким образом формируется очередь на обмен с конкретным узлом.

Контроль за порядком выгрузки - загрузки
За контроль порядка выгрузки/загрузки отвечает задание "Регламентное фоновое задание по контролю обмена". Оно запускается каждые 60 сек. и выполняет запуск фоновых заданий, которые отвечают за загрузку и выгрузку данных. Для этого выбираются узлы плана обмена РаспределеннаяКонфигурация и для каждого узла создается фоновое задание:
Метод: ОбменДанными.РБД_Обмен_с_РаспределеннаяКонфигурация(_УзелОбмена)
Ключ: оду<Код узла обмена>{_}.
Наименование: Обмен с узлом "<Наименование узла обмена>".
В качестве параметра передается узел, с которым обмениваемся.

Фоновое задание осуществляет контроль чтения и записи между ЭтотУзел и УзелОбмена. Методы чтения и записи находятся в обработке ОбменДаннымиРаспределеннаяКонфигурация. Также фоновое может подменить обработку обмена патчем, который указывается в справочнике ИБД (реквизит ОбработкаОбменаДанных).

Последовательность событий такая:

Пытаемся прочитать (и загрузить) пакет (метод ЧтениеОтУзла). Следующая попытка чтения будет через минуту.
Если пакет прочитали, то смещаем дату записи пакета. Если последняя запись была более чем 10 минут назад, то смещаем на 1 минуту от текущего времени, а если менее, то на 5 минут.
Если пакет не прочитан, то дату записи не смещаем. Чтение управляет следующей записью.
Пытаемся записать пакет (метод ЗаписьДляУзла). Следующая попытка записи будет через 5 минут.
Если пакет записали, то смещаем дату следующего чтения на 5 минут. Запись управляет следующим чтением.
Все эти действия находятся в бесконечном цикле, т.к. обмен данными это постоянный процесс. Тем не менее, цикл прерывается в определенных ситуациях:

Узел удалили или пометили на удаление;
Узел является этим узлом (сам в себя выгружать данные не должен);
Признак автоматического обмена выключен;
Нет активных фоновых заданий (с ключом соответствующим коду узла);
На БД наложена блокировка.
Выгрузка данных
Регламентное задание определило, что необходимо произвести выгрузку данных. Подробнее опишем этот процесс:

Формируем имя файла сообщения по узлам обмена.
Проверяем наличие файла во временной директории обмена. Если файл есть, то его необходимо отправить, формировать новый не требуется.
Проверяем последовательность номеров сообщений.
Отправка в подчиненный.
Если отправили больше чем приняли, то ждем ответного пакета.
Если номер отправленного меньше чем номер принятого, то присваиваем номеру отравленного номер принятого (далее номер отправленного будет увеличен на единицу).

Отправка в родительский.
Если номер отправленного больше либо равен номеру принятого, то ждем ответного пакета.
Если приняли на несколько пакетов больше чем отправили (более одного), то номеру отправленного присваиваем номер предпоследнего принятого (далее он будет увеличен на 1 и уравняется с номером принятого).

Формируем запись заголовка сообщения.
Формируем блок дополнительной информации. Тег "AdditionalInformation". 
Содержит информацию о сложном обновлении.
Формируем блок измененных данных (обновление конфигурации).
Команда удаления регистрации изменений. Атрибут "UtilityCommand.УдалениеРегистрацииИзменений". Обязательно должен присутствовать.
Выгружаем объектные данные (все кроме документов). Каждый объект проверяем на выгрузку: ПриОтправкеДанныхПодчиненному, ПриОтправкеДанныхГлавному (в текущий момент не используется). Используется механизм ограничения выгружаемых данных.
Выгрузка документов. Выгружаются с помощью механизма альтернативной регистрации (РС.РегистрацияДокументов).
Средствами SQL проставляем номер пакета записям регистра.
Затем по номеру пакета выбираем записи регистра содержащие ссылки на документы.
С документами выбираются их движения.
При записи в пакет обмена документ с движениями вставляем в тег "v8de:Transaction". Проверка наличия дополнительных данных для вставки в транзакцию "ОбменДанными.ПолучитьДополнительныеДанныеДляВыгрузкиВТранзакцииДокумент" (проект маркировка)
Выгрузка документов со стандартной регистрацией.
Выгрузка регистров.
Выгрузка данных в виде команды SQL (регистры сведений: ТекущийОстатокТовара, ПодневныйПрогнозПродаж, Цены_НоменклатурыРекомендованныеТекущие).
При отправке к подчиненному передаем команду SQL и время записи.
При отправке к главному передаем время записи. Необходимо для отслеживания записей, которые уже отправлены. Далее будут выгружаться записи, у которых время больше чем у последних принятых. 
Выгружаем регистр "информация по ИБД" с информацией о периодах загрузки/выгрузки. 
При отправке в главный узел передаем информацию о базах подчиненных текущей.
При отправке в подчиненный — передаем информацию о все базах кроме подчиненных базе, которой передаем. 
В момент формирования пакета в конкретный узел зарегистрированы все объекты, которые менялись в базе. Но в региональной базе должна находится только информация, которая относится к конкретно этому региону, поэтому в момент выгрузки данных мы проверяем, необходимо ли указанный объект выгружать в региональную базу или нет.
Ограничение выгружаемых данных
ПЕРВЫЙ СПОСОБ при выгрузке
Ограничения накладываются на метаданные:

Документы
Регистры сведений
Регистры накопления
Регистры бухгалтерии
У выгружаемого объекта проверяются поля (реквизиты, измерения, ресурсы) на типы:

СправочникСсылка.Фирмы;
СправочникСсылка.СкладыФилиала;
СправочникСсылка.Города;
ПеречислениеСсылка.Регионы.
Если такие поля есть, то формируется правило проверки: проверяем, входит ли значение поля в список разрешенных Складов/Фирм/Городов/Регионов. Если объект не проходит проверку, то не выгружается.
Так же проверку проходит каждая запись наборов записей: записи, которые не проходят проверку, удаляются из набора при выгрузке.
Важно!!! Если при выгрузке нужна нестандартная проверка, то в модуле объекта метаданного необходимо поместить экспортную функцию, выполняющую проверку выгрузки объекта.

Проверка документов на выгрузку в узел
Для документов используется функция ПроверитьДокументНаВыгрузкуВУзел(_обУзел).

Если объект необходимо выгружать, функция возвращает ИСТИНА, иначе — ЛОЖЬ. 

_обУзел содержит поля и методы, которые можно использовать при написании проверки:

МВТ - содержит временные таблицы для использования в запросах при проверке
втФилиалыДляВыгрузки
втГородаДляВыгрузки
втСкладыДляВыгрузки
пСписокРазрешенныхРегионов
пСписокРазрешенныхФилиалов
пСписокРазрешенныхГородов
пСписокРазрешенныхСкладов
ПроверитьФилиал(_ссФилиал) - если _ссФилиал входит в список разрешенных для выгрузки, то возвращает истину, иначе — ложь.
ПроверитьСклад(_ссСклад) - если _ссСклад входит в список разрешенных для выгрузки, то возвращает истину, иначе — ложь. 
Пример:


Функция ПроверитьДокументНаВыгрузкуВУзел(УзелОбъект = Неопределено) Экспорт
	
	Если УзелОбъект = Неопределено Тогда Возврат Ложь КонецЕсли; //проверка наличия/существования этого метода из обмена
	
	//Сначала проверим относиться ли Фирма или ФилиалПолучатель к выгружаемому узлу
		Если УзелОбъект.ПроверитьФилиал(Фирма) = Истина Тогда 		 
		Возврат Истина; //если вернем истину тогда этот документ пойдет в обмен
	КонецЕсли;   
	
	//Теперь необходимо Проверить Есть ли в табличных частях филиалы которые приписаны к региону выгружаемого узла
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = УзелОбъект.МВТ;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	1 КАК Поле1
	|ИЗ
	|	Документ.ТТН.ПолучателиГрузов КАК ПолучателиГрузов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втФилиалыДляВыгрузки КАК вт0
	|		ПО ПолучателиГрузов.ПолучательТТН = вт0.Ссылка
	|ГДЕ
	|	ПолучателиГрузов.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", ?(ЭтоНовый(), ПолучитьСсылкуНового(), Ссылка));
	
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции
Проверка регистров на выгрузку в узел
Для регистров используется функция ПолучитьПравилоПроверкиПриВыгрузке(_ссУзел), которая возвращает строку команды для проверки записей набора записей.
Если набор должен выгружаться полностью, функция должна возвращать строку "//".


Функция ПолучитьПравилоПроверкиПриВыгрузке(_ссУзел) Экспорт

	Тип_ = ТипЗнч(_ссУзел);
	Если Тип_ = Тип("ПланОбменаСсылка.Базовый") Тогда
		Возврат
		"Для Каждого Движение Из ЭлементДанных Цикл
		|Если Движение.Город = Справочники.Города.ПустаяСсылка() Тогда
		|         	Продолжить;
		|КонецЕсли;
		|
		|Если НЕ (пСписокРазрешенныхГородов[Движение.Город] = Истина) Тогда
		|         	СписокУдаляемых.Вставить(0, Движение);
		|КонецЕсли;
		|КонецЦикла";
	Иначе  
		Возврат "//";
	КонецЕсли;

КонецФункции 
Внимание!

ПолучитьПравилоПроверкиПриВыгрузке - является устаревшим не оптимальным методом. Ограничения были переведены на новый метод ПолучитьПравилоПроверкиПриВыгрузкеЗапрос.


Функция ПолучитьПравилоПроверкиПриВыгрузкеЗапрос(Узел) Экспорт
	Тип_ = ТипЗнч(Узел);
	Если Тип_ = Тип("ПланОбменаСсылка.Базовый") Тогда
		Возврат "		
		|ЛЕВОЕ СОЕДИНЕНИЕ втГородаДляВыгрузки КАК втГородаДляВыгрузки
		|ПО Движения.Город = втГородаДляВыгрузки.Ссылка 
		|ГДЕ
		|(НЕ втГородаДляВыгрузки.Ссылка ЕСТЬ NULL
		|              ИЛИ Движения.Город = ЗНАЧЕНИЕ(Справочник.Города.ПустаяСсылка))";
	Иначе
		Возврат "";
	КонецЕсли;	
КонецФункции


Правила которые необходимо соблюдать при составлении ограничений в функции ПолучитьПравилоПроверкиПриВыгрузкеЗапрос()
Движения - предопределеное имя обозначающие текущий набор регистра
Для проверок в запросе существуют следующие временные таблицы:
втФилиалыДляВыгрузки
втГородаДляВыгрузки
втСкладыДляВыгрузки
втРегионыДляВыгрузки
Возврат пустой строки "" эквивалентен возврату "//"
ВТОРОЙ СПОСОБ при получении данных от Главного/Подчиненного
Индивидуальные проверки по типу объект метаданных в процедуре ПриПолученииДанныхОтПодчиненного
Регистр сведений ГраницаПоследовательностиВалют.
Если в текущем узле граница последовательности больше, чем в пришедшей записи, то не загружаем.
Регистр сведений ИсторияПродаж_СерийныеНомера.
Если в текущем узле запись имеет Дату сверки отличную от пустой, либо признак Принят, то не загружаем.
Регистр сведений ВозвратОплатыЯндексДеньги. 
Если в текущем узле запись имеет Статус со значением больше нуля, то не загружаем.
Регистр сведений СканированиеЦенниковВитрины.
Если данные пришли в главный узел, то очищаем все узлы-получатели Базового обмена. Далее дополняем получателей узлами, в которых есть филиалы соответствующие основному отбору данного регистра.
Документ ТаможенныеУслуги.
Не загружать. 
Индивидуальные проверки по типу метаданных в процедуре ПриПолученииДанныхОтГлавного.
Регистр сведений ГраницаПоследовательностиВалют.
Если в текущем узле граница последовательности больше, чем в пришедшей записи, то не загружаем. 
Индивидуальные проверки по типу метаданных в процедуре ПриОтправкеДанныхПодчиненному.
В рамках данной процедуры происходит дополнительный контроль данных, которые не должны быть отправлены в подчиненный узел, с их последующей очисткой из очереди отправки.

Дополнительные правила в данном случае могут быть заданы для:

Регистров накопления
Регистров сведений
Регистров бухгалтерии
Документов
ТРЕТИЙ СПОСОБ при чтении сообщения обмена
Применяется для документов при загрузке в Центральный узел.
Для работы механизма в модуле менеджера документа необходимо разместить процедуру ОграничитьПолучателейПриОбмене.
Процедура выполняет чистку узлов-получателей плана обмена Базовый.

Определяем списков филиалов, которые находятся в узле для выгрузки.
Определяем реквизиты документа, которые имеют тип Фирма.
По реквизиту документа ограничиваем список узлов.
ВАЖНО!!! Также можно выполнить ограничение узлов-получателей по табличной части документа.

Загрузка данных
Регламентное задание определило, что нам необходимо произвести загрузку данных.

Формируем имя файла сообщения по узлам обмена.
Проверяем наличие файла сообщения в директории обмена.
Перемещаем файл сообщения во временную директорию текущего узла.
Начинаем чтение файла сообщения.
Проверяем наличие конфигурации для обновления. Если конфигурация есть, то мы завершаем чтение пакета и переходим к обновлению конфигурации. Для этого используется специальный скрипт, который производит следующие операции:
      • Запрещает вход в базу.
      • Завершает сеансы: пользователей и фоновые. При необходимости перезагружает Агент 1С.
      • Запускает конфигуратор с командой обновления.
      • Закрывает конфигуратор и снимаем запрет на вход.

Чтение данных.
Если пакет загружается повторно, то пропускаем уже загруженные данные.
Контроль загруженных данных осуществляется с помощью регистра сведений "Статистика по времени загрузки".
Читаем из файла номер последнего успешно загруженного пакета в базе источнике. Выполняем команду удаления записей из таблиц регистрации по данному номеру.
Удаление средствами 1С.
Удаление средствами SQL для регистра сведений "Регистрация документов".
Выполнение спец. команд.
После команды удаления регистрации может идти блок команд на языке SQL.
На текущий момент используется для регистров сведений: ТекущийОстатокТовара, ПодневныйПрогнозПродаж, Цены_НоменклатурыРекомендованныеТекущие.
Загружаемый блок содержит имя процедуры, которую необходимо запустить для выполнения команды SQL, время, в которое выполнялась выгрузка данных, и команду SQL.
После выполнения команды SQL в специальный регистр делается запись с пометкой времени загруженных данных из узла.
Чтение данных.
Ограничение узлов-получателей для данных.
Если данные пришли из главного узла, то ограничения не накладываются.
Если данные пришли из подчиненного, тогда проверяем, входит ли тип метаданного в состав подписки на событие нзТолькоВверх, если входит, то удаляем из получателей все узлы кроме главного.
Выполняются предварительные проверки по типам метаданных.
Регистры накопления: если загружается Счет_41, Счет_45, Счет_79_1_, РезервыТоваров, формируем запрос на синхронизацию текущих остатков.
Читаем блок данных. Возможны два варианта:
      •  Читаем блок данных, которые должны записываться в одной транзакции (документ с движениями). Формируем массив, в который записываем такие данные.
      •  Читаем данные, которые записываются независимо.
Если для объекта есть запрос для синхронизации остатков, то в зависимости от параметра сеанса ТриггернаяСинхронизацияТекущихОстатков выполняем синхронизацию, если параметр имеет значение истина, то ничего не делаем, синхронизация производится средствами SQL, если ложь, то производим синхронизацию текущих остатков средствами 1С.
В случае если синхронизируем средствами 1С, изменения текущих остатков пишем в транзакции с объектом данных. 
Запись данных в базу.
Ограничиваем список узлов получателей, полученных в пункте 11. 
Накладываются ограничения на загружаемые объекты по приоритету миграции. На данный момент приоритет имеют данные полученные от главного узла. Работает для документов. 
Возможны случаи:
      •  Если загружен документ из главного узла без движений, а в текущей ИБД этот документ имеет регистрацию с движениями, то не загружаем такой объект.
      •  Если документ пришел с движениями из главного узла и в текущей ИБД этот документ имеет регистрацию, то производим запись объекта.
      •  Если документ помечен на удаление, то в движения записываются пустые наборы
Делаем служебную запись в регистр сведений "Статистика по времени загрузки" с видом метаданных "Information_fon".
У узла-владельца меняем значение номера принятого сообщения.
Удаляем служебную запись из регистра сведений "Статистика по времени загрузки".
Удаляем сообщение из временной директории.
Оптимизация загрузки данных
Одна из особенностей обмена в том, что чтение из файла обмена происходит в несколько потоков для того, чтобы ускорить этот процесс и снизить влияние блокировки одного объекта на всё время загрузки. Вот каким способом это сделано (в общих чертах):

Регламентное задание "РБДКонтроль" запускает фоновый процесс для каждого из узлов базового обмена (и контролирует его активность). Исполняемый код задания находится в обработке обмена.
Это фоновое задание (допустим "Обмен с узлом "Урал (Екатеринбург)") контролирует очерёдности и необходимость загрузки/выгрузки файлов обновления для своего узла.
Если оно определяет необходимость и возможность загрузки новых данных, то берёт файл-архив и распаковывает его, получая XML-файл.
Происходит просмотр файла и заполнение регистра "ОчередьМногопоточнойЗагрузки", где фиксируется нижний и верхний указатель порции данных. Для этого используются номера из тэгов "Order=ХХ" из XML-структуры:

Затем это же задание считывает настройки из константы "КоличествоПотоковОбмена" и запускает фоновые задания-потоки. После первого запуска они будут активны постоянно.

В свою очередь эти задания начинают "расхватывать" порции из регистра "ОчередьМногопоточнойЗагрузки" и по указанным интервалам считывать (загружать) информацию из XML-файла.
Каждое из заданий-потоков делает записи в регистр "СтатистикаПоВремениЗагрузки_" и по завершению берёт новую порцию.
Каждое задание-поток постоянно проверяет настройки константы "КоличествоПотоковОбмена" и изменение других условий для корректировки своих действий.
Как и было сказано ранее, это упрощенное описание процесса многопоточной загрузки, который более углубленно можно изучить самостоятельно. Всё управление этим механизмом в интерфейсе можно найти на форме мониторинга планов обмена.

Здесь есть вызов настройки константы "КоличествоПотоковОбмена"

Есть просмотр распределения порций и состояние их загрузки из регистра "ОчередьМногопоточнойЗагрузки" 

(нужно сделать активной строку с интересующим узлом) или посмотреть все текущие загружаемые пакеты.

Инструменты для контроля обменов
Для того чтобы понимать, в каком состоянии на текущий момент находятся обмены и какие ошибки возникают, используется ряд инструментов.

Мониторинг
http://adm-monitor-dev:52081/ - показывает текущее состояние системы

Мониторинг в базе 1С
План обмена

Показывает время последнего чтения\записи файла обмена. Добавлена цветовая схема, для контроля отклонений.

Белый – все хорошо
Желтый – задержка чтения\записи файла
Красный – превышено оптимальное время чтения\записи файла. В данном случае скорее всего возникла ошибка чтения\записи файла обмена
Статистика по времени загрузки

Показывает статистику по загружаемым данным.

Журнал регистрации

Показывает как удачные, так и неудачные события обмена.

Уведомления
Для более оперативного реагирования на проблемы мы используем настраиваемые уведомления при помощи различных каналов связи.

Телеграмм
Уведомления в телеграмм канал об ошибках и ходе обновления баз.


Rocket.Chat
Уведомления в рокет чат о возникающих ошибках


Технологический журнал

Обработка по контролю за блокировками (технологический журнал) – показывает блокировки, из-за которых возможно заблокирована возможность использования некоторых инструментов БД.
